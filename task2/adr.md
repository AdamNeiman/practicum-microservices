### <a name="_b7urdng99y53"></a>**Название задачи:** Высокоуровневое проектирование — контейнерная диаграмма (C2)
### <a name="_hjk0fkfyohdk"></a>**Автор:** Штокало Андрей
### <a name="_uanumrh8zrui"></a>**Дата:** 27 июля 2025

---

### Ограниченные контексты и микросервисы

| Ограниченный контекст                | Описание                                            | Кандидаты в микросервисы                   |
| :----------------------------------- | :-------------------------------------------------- | :----------------------------------------- |
| Видеоаналитика и события             | Обработка и анализ видеопотоков, детекция событий   | video-analytics-service, event-service     |
| Управление устройствами (Edge Agent) | Взаимодействие с кормушками, поилками, датчиками    | edge-agent-service, device-control-service |
| Хранилище данных и интеграция        | Сбор, хранение, агрегация данных, интеграция с ERP  | storage-service, integration-service       |
| Уведомления и оповещения             | Доставка тревог и уведомлений операторам и сервисам | notification-service                       |
| Пользователи и доступ                | Аутентификация, авторизация, роли                   | identity-service                           |

---

### Контейнерная диаграмма — Вариант 1 (основной)

```plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(operator, "Оператор фермы", "Следит за состоянием животных и техники")
Person(admin, "Администратор", "Настраивает систему и следит за безопасностью")

System_Boundary(central, "Центральный сервер") {
    Container(video, "Video Analytics Service", "Python, TensorFlow", "Обработка видеопотоков, генерация событий")
    Container(event, "Event Service", "Node.js", "Реестр событий и инцидентов, API для получения тревог, использует Kafka для получения/отправки событий")
    Container(notification, "Notification Service", "Go", "Оповещения операторов и интеграция с внешними системами")
    Container(storage, "Storage Service", "PostgreSQL, S3-compatible", "Хранение данных и видеороликов")
    Container(integration, "ERP Integration", "Python", "Сбор и передача метрик в ERP")
    Container(identity, "Identity Service", "Keycloak", "Аутентификация и авторизация пользователей")
}

System(edge, "Edge Agent Service", "C++, Python", "Локальное управление устройствами, буферизация событий, работа офлайн")

Rel(operator, notification, "Получает оповещения")
Rel(admin, identity, "Управляет доступом")
Rel(edge, event, "Передаёт события")
Rel(video, event, "Передаёт события")
Rel(event, notification, "Генерирует тревоги")
Rel(event, storage, "Сохраняет события и логи")
Rel(storage, integration, "Передаёт метрики")
Rel(notification, operator, "Отправляет уведомления")
Rel(identity, all, "Проверяет права доступа")

@enduml
```

#### Технологии и интеграции

* Apache Kafka для событий
* S3-совместимое хранилище (MinIO) для видео
* REST/gRPC для взаимодействия сервисов
* Keycloak или Auth0 для IAM
* ERP через интеграционный сервис
* Edge-агенты могут работать в оффлайн режиме (буферизация)

#### Преимущества

* Масштабируемость и гибкость микросервисов
* Надёжная обработка событий (Kafka)
* Возможность офлайн работы агентов
* Централизованная IAM

#### Ограничения

* Сложность поддержки большого количества сервисов
* Требуется сложная инфраструктура (Kafka, S3, IAM)

---

### Контейнерная диаграмма — Вариант 2 (альтернативный)

```plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(operator, "Оператор фермы", "Следит за состоянием животных и техники")

System_Boundary(central, "Монолитный сервер (упрощённый)") {
    Container(monolith, "AgroMonolith", "Python, Flask", "Обработка видео, событий, оповещений, интеграция, хранение — всё в одном")
    Container(identity, "Identity Service", "Встроенный", "Аутентификация и авторизация пользователей")
}

System(edge, "Edge Agent Service", "C++, Python", "Локальное управление устройствами, буферизация событий, работа офлайн")

Rel(operator, monolith, "Получает оповещения и работает через UI")
Rel(edge, monolith, "Передаёт данные и события")
Rel(identity, monolith, "Проверяет права доступа")

@enduml
```

#### Технологии и интеграции

* RabbitMQ для передачи событий (или даже REST)
* Локальный PostgreSQL
* Все функции (аналитика, оповещения, интеграция) — внутри одного контейнера
* Edge-агенты также поддерживают офлайн режим

#### Преимущества

* Проще развёртывание и сопровождение (всё в одном)
* Меньше инфраструктурных требований
* Быстрый MVP

#### Ограничения

* Хуже масштабируемость
* Нет гибкости микросервисов
* Менее надёжная обработка событий при увеличении нагрузки

---

### Компромиссы и риски

* Микросервисная архитектура (Вариант 1) сложнее для MVP, но даёт выигрыш в масштабируемости
* Монолит (Вариант 2) проще и быстрее, но упирается в ограничения по росту и надёжности
* Kafka/RabbitMQ/S3 требуют отдельной поддержки и мониторинга
* Edge-агенты — критическая точка: их сбой нарушает работу всей фермы

---

> Все исходные диаграммы находятся в файлах: 
> 
> [Диаграмма C2 - основной вариант](./C2_main.puml) 
>
>[Диаграмма C2 - альтернативный вариант](./C2_alt.puml)
